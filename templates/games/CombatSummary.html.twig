{% extends 'base.html.twig' %}

{% block title %}Combat{% endblock %}

{% block body %}
<section id="battle">
    <div class="battle">
        <div class="team-container">
            <div class="title">
                <h2>
                    Combat: {{ teamA.user ? (teamA.user.pseudo ?? teamA.user.email ?? 'Joueur ' ~ teamA.user.id) : 'Equipe A' }}
                    vs
                    {{ teamB.user ? (teamB.user.pseudo ?? teamB.user.email ?? 'Joueur ' ~ teamB.user.id) : 'Equipe B' }}
                </h2>
            </div>
            <div class="title-area">
                <div class="title">
                    <h2>Mon equipe</h2>
                </div>
                <div class="title">
                    <h2>Adversaire</h2>
                </div>
            </div>
            <div class="battleground">
                <div class="team-card">
                    <div id="unitOne">
                        <div id="unitOnePreview">
                            {% if teamA.unitOne %}{% include 'games/units/_unit_card_battle.html.twig' with { unit: teamA.unitOne } %}{% endif %}
                        </div>
                    </div>
                    <div id="unitTwo">
                        <div id="unitTwoPreview">
                            {% if teamA.unitTwo %}{% include 'games/units/_unit_card_battle.html.twig' with { unit: teamA.unitTwo } %}{% endif %}
                        </div>
                    </div>
                    <div id="unitThree">
                        <div id="unitThreePreview">
                            {% if teamA.unitThree %}{% include 'games/units/_unit_card_battle.html.twig' with { unit: teamA.unitThree } %}{% endif %}
                        </div>
                    </div>
                </div>
                <div class="vs"></div>
                <div class="team-card">
                    <div id="unitOne">
                        <div id="unitOnePreview">
                            {% if teamB.unitOne %}{% include 'games/units/_unit_card_battle.html.twig' with { unit: teamB.unitOne, advesary: true } %}{% endif %}
                        </div>
                    </div>
                    <div id="unitTwo">
                        <div id="unitTwoPreview">
                            {% if teamB.unitTwo %}{% include 'games/units/_unit_card_battle.html.twig' with { unit: teamB.unitTwo, advesary: true } %}{% endif %}
                        </div>
                    </div>
                    <div id="unitThree">
                        <div id="unitThreePreview">
                            {% if teamB.unitThree %}{% include 'games/units/_unit_card_battle.html.twig' with { unit: teamB.unitThree, advesary: true } %}{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-3" style="text-align:center;">
                {% set winner = result.winner %}
                {% if winner == 'A' %}
                    <span class="badge bg-success">Vainqueur: Equipe A</span>
                {% elseif winner == 'B' %}
                    <span class="badge bg-success">Vainqueur: Equipe B</span>
                {% else %}
                    <span class="badge bg-secondary">Egalité</span>
                {% endif %}
            </div>

            <div class="mt-4" style="width:100%; max-width: 960px;">
                <h3>Déroulé du combat</h3>
                {% if result.turns is empty %}
                    <p>Aucun tour (aucune unité disponible).</p>
                {% else %}
                <ol class="list-group list-group-numbered">
                {% for t in result.turns %}
                    <li class="list-group-item" style="display:flex; flex-direction:column; gap:.25rem;">
                        <div>
                            <strong>Tour {{ t.order }}</strong>
                            — Acteur:
                            <span class="badge {{ t.actor.team == 'A' ? 'bg-primary' : 'bg-danger' }}">
                                {{ t.actor.team }}: {{ t.actor.name }} ({{ t.actor.slot }})
                            </span>
                            — Action:
                            <span class="badge {{ t.action == 'special' ? 'bg-warning text-dark' : 'bg-info text-dark' }}">
                                {{ t.action == 'special' ? 'Coup spécial' : 'Attaque' }}
                            </span>
                        </div>
                        <div>
                            Cible:
                            <span class="badge {{ t.target.team == 'A' ? 'bg-primary' : 'bg-danger' }}">
                                {{ t.target.team }}: {{ t.target.name }} ({{ t.target.slot }})
                            </span>
                            — Dégâts: <strong>{{ t.damage }}</strong>
                            — Vita: {{ t.targetVitaBefore }} → <strong>{{ t.targetVitaAfter }}</strong>
                            {% if not t.target.alive %}
                                <span class="badge bg-dark">K.O</span>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
                </ol>
            {% endif %}
            </div>

            <div class="mt-4" style="width:100%; max-width:960px;">
                <h3>Etat final</h3>
                <div class="row">
                    <div class="col">
                        <h5>Equipe A</h5>
                        <ul class="list-group">
                        {% for u in result.final.A %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ u.name }} ({{ u.slot }}) — Vita: {{ u.vita }} — Att: {{ u.att }} — Init: {{ u.init }}
                                {% if u.alive %}<span class="badge bg-success">Vivant</span>{% else %}<span class="badge bg-secondary">K.O</span>{% endif %}
                            </li>
                        {% endfor %}
                        </ul>
                    </div>
                    <div class="col">
                        <h5>Equipe B</h5>
                        <ul class="list-group">
                        {% for u in result.final.B %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ u.name }} ({{ u.slot }}) — Vita: {{ u.vita }} — Att: {{ u.att }} — Init: {{ u.init }}
                                {% if u.alive %}<span class="badge bg-success">Vivant</span>{% else %}<span class="badge bg-secondary">K.O</span>{% endif %}
                            </li>
                        {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <a class="btn btn-outline-primary" href="{{ path('opponents_list') }}">Retour aux adversaires</a>
            </div>
        </div>
    </div>
</section>
{% endblock %}
