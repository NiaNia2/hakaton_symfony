{% extends 'base.html.twig' %}

{% block title %}Combat{% endblock %}

{% block body %}
<section id="battle">
    <div class="battle">
        <div class="team-container">
            <div class="title">
                <h2>
                    Combat: {{ teamA.user ? (teamA.user.pseudo ?? teamA.user.email ?? 'Joueur ' ~ teamA.user.id) : 'Equipe A' }}
                    vs
                    {{ teamB.user ? (teamB.user.pseudo ?? teamB.user.email ?? 'Joueur ' ~ teamB.user.id) : 'Equipe B' }}
                </h2>
            </div>
            <div class="title-area">
                <div class="title">
                    <h2>Mon equipe</h2>
                </div>
                <div class="title">
                    <h2>Adversaire</h2>
                </div>
            </div>
            <div class="battleground">
                <div class="team-card">
                    <div id="unit-A-one" class="unit-container" data-team="A" data-slot="one">
                    <div id="unitOnePreview">
                            {% if teamA.unitOne %}{% include 'games/units/_unit_card_battle.html.twig' with { unit: teamA.unitOne, team: 'A', slot: 'one' } %}{% endif %}
                        </div>
                    </div>
                    <div id="unit-A-two" class="unit-container" data-team="A" data-slot="two">
                    <div id="unitTwoPreview">
                            {% if teamA.unitTwo %}{% include 'games/units/_unit_card_battle.html.twig' with { unit: teamA.unitTwo, team: 'A', slot: 'two' } %}{% endif %}
                        </div>
                    </div>
                    <div id="unit-A-three" class="unit-container" data-team="A" data-slot="three">
                    <div id="unitThreePreview">
                            {% if teamA.unitThree %}{% include 'games/units/_unit_card_battle.html.twig' with { unit: teamA.unitThree, team: 'A', slot: 'three' } %}{% endif %}
                        </div>
                    </div>
                </div>
                <div class="vs"></div>
                <div class="team-card">
                    <div id="unit-B-one" class="unit-container" data-team="B" data-slot="one">
                    <div id="unitOnePreview">
                            {% if teamB.unitOne %}{% include 'games/units/_unit_card_battle.html.twig' with { unit: teamB.unitOne, team: 'B', slot: 'one', advesary: true } %}{% endif %}
                        </div>
                    </div>
                    <div id="unit-B-two" class="unit-container" data-team="B" data-slot="two">
                    <div id="unitTwoPreview">
                            {% if teamB.unitTwo %}{% include 'games/units/_unit_card_battle.html.twig' with { unit: teamB.unitTwo, team: 'B', slot: 'two', advesary: true } %}{% endif %}
                        </div>
                    </div>
                    <div id="unit-B-three" class="unit-container" data-team="B" data-slot="three">
                    <div id="unitThreePreview">
                            {% if teamB.unitThree %}{% include 'games/units/_unit_card_battle.html.twig' with { unit: teamB.unitThree, team: 'B', slot: 'three', advesary: true } %}{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-2" style="text-align:center;">
                <a class="btn-alt"
                        hx-swap="none"
                        data-turns='{{ result.turns|json_encode(constant("JSON_HEX_TAG") b-or constant("JSON_HEX_AMP") b-or constant("JSON_HEX_APOS") b-or constant("JSON_HEX_QUOT")) }}'
                        hx-on:click="(function(btn,evt){
                            const turns = JSON.parse(btn.getAttribute('data-turns')||'[]');
                            playTurns(turns);
                        })(this,event)"
                >Jouer l'animation</a>
            </div>

            <div class="mt-4 redirecte">
                <a class="btn-alt" href="{{ path('opponents_list') }}">Retour aux adversaires</a>
            </div>

            <div class="mt-4" style="width:100%; max-width: 960px;">
                <h3>Déroulé du combat</h3>
                {% if result.turns is empty %}
                    <p>Aucun tour (aucune unité disponible).</p>
                {% else %}
                    <ol class="list-group list-group-numbered">
                    {% for t in result.turns %}
                        <li class="list-group-item" style="display:flex; flex-direction:column; gap:.25rem;">
                            <div>
                                <strong>Tour {{ t.order }}</strong>
                                — Acteur:
                                <span class="badge {{ t.actor.team == 'A' ? 'bg-primary' : 'bg-danger' }}">
                                    {{ t.actor.team }}: {{ t.actor.name }} ({{ t.actor.slot }})
                                </span>
                                — Action:
                                <span class="badge {{ t.action == 'special' ? 'bg-warning text-dark' : (t.action == 'heal' ? 'bg-success' : 'bg-info text-dark') }}">
                                    {% if t.action == 'heal' %}Soin{% elseif t.action == 'special' %}Coup spécial{% else %}Attaque{% endif %}
                                </span>
                            </div>
                            {# --- ICI on distingue attaque vs soin --- #}
                            {% if t.action == 'heal' %}
                                <div>
                                    Cible (soin):
                                    <span class="badge {{ t.healTarget.team == 'A' ? 'bg-primary' : 'bg-danger' }}">
                                        {{ t.healTarget.team }}: {{ t.healTarget.name }} ({{ t.healTarget.slot }})
                                    </span>
                                    — Soin: <strong>{{ t.heal }}</strong>
                                    — Vita: {{ t.healVitaBefore }} → <strong>{{ t.healVitaAfter }}</strong>
                                </div>
                            {% else %}
                                <div>
                                    Cible:
                                    <span class="badge {{ t.target.team == 'A' ? 'bg-primary' : 'bg-danger' }}">
                                        {{ t.target.team }}: {{ t.target.name }} ({{ t.target.slot }})
                                    </span>
                                    — Dégâts: <strong>{{ t.damage }}</strong>
                                    — Vita: {{ t.targetVitaBefore }} → <strong>{{ t.targetVitaAfter }}</strong>
                                    {% if t.target is defined and (t.target.alive is defined) and not t.target.alive %}
                                        <span class="badge bg-dark">K.O</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </li>
                    {% endfor %}
                    </ol>
                {% endif %}
                <div class="mt-3" style="text-align:center;">
                    {% set winner = result.winner %}
                    {% if winner == 'A' %}
                        <span class="badge bg-success">Vainqueur: Vous avez gagné</span>
                    {% elseif winner == 'B' %}
                        <span class="badge bg-success">Vainqueur: L'équipe adverse</span>
                    {% else %}
                        <span class="badge bg-secondary">Egalité</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
